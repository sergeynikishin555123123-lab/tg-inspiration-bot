require('dotenv').config();
const express = require('express');
const path = require('path');
const TelegramBot = require('node-telegram-bot-api');
const cors = require('cors');

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(express.json());
app.use(cors());
app.use(express.static('public'));

// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ° Ñ LONG POLLING
const bot = new TelegramBot(process.env.BOT_TOKEN, {
  polling: {
    interval: 300,
    autoStart: true,
    params: {
      timeout: 10
    }
  }
});

console.log('ğŸ¤– Bot starting in POLLING mode...');

// Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğµ Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
const users = new Map();

// Health check
app.get('/health', (req, res) => {
  res.json({ 
    status: 'OK', 
    message: 'âœ… Ğ‘Ğ¾Ñ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ñ‡ĞµÑ€ĞµĞ· long polling!',
    mode: 'polling',
    users_count: users.size,
    timestamp: new Date().toISOString()
  });
});

// API Ğ´Ğ»Ñ Mini App - Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
app.get('/api/user/:userId', (req, res) => {
  const { userId } = req.params;
  const user = users.get(userId);
  
  if (!user) {
    return res.json({ exists: false });
  }
  
  res.json({ exists: true, user });
});

// API Ğ´Ğ»Ñ Mini App - Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
app.post('/api/user/register', (req, res) => {
  try {
    const { userId, username, name, userClass, character } = req.body;
    
    const user = {
      user_id: userId,
      tg_username: username,
      tg_name: name,
      class: userClass,
      character: character,
      stars: 0,
      level: 'Ğ£Ñ‡ĞµĞ½Ğ¸Ğº',
      created_at: new Date().toISOString()
    };
    
    users.set(userId.toString(), user);
    res.json({ success: true, message: 'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½' });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Serve Mini App
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /start
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  const username = msg.from.username || '';
  const name = msg.from.first_name || 'Ğ”Ñ€ÑƒĞ³';
  
  console.log(`ğŸ‘‹ ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: ${name} (ID: ${userId})`);
  
  // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
  const user = {
    user_id: userId,
    tg_username: username,
    tg_name: name,
    stars: 0,
    level: 'Ğ£Ñ‡ĞµĞ½Ğ¸Ğº',
    created_at: new Date().toISOString()
  };
  
  users.set(userId.toString(), user);
  
  const welcomeText = `ğŸ¨ ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, ${name}! 

Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² **ĞœĞ°ÑÑ‚ĞµÑ€ÑĞºÑƒÑ Ğ’Ğ´Ğ¾Ñ…Ğ½Ğ¾Ğ²ĞµĞ½Ğ¸Ñ**! 

âœ¨ Ğ’Ğ¾Ñ‚ Ñ‡Ñ‚Ğ¾ Ğ²Ğ°Ñ Ğ¶Ğ´ĞµÑ‚:
â€¢ ğŸ“š ĞĞ±ÑƒÑ‡Ğ°ÑÑ‰Ğ¸Ğµ Ğ²Ğ¸Ğ´ĞµĞ¾ Ğ¸ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ
â€¢ â­ Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ¹ Ğ¸ Ğ·Ğ²Ñ‘Ğ·Ğ´
â€¢ ğŸ† Ğ”Ğ¾ÑÑ‚Ğ¸Ğ¶ĞµĞ½Ğ¸Ñ Ğ¸ Ğ±Ğ¾Ğ½ÑƒÑÑ‹
â€¢ ğŸ‘¥ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµÑÑ‚Ğ²Ğ¾ ĞµĞ´Ğ¸Ğ½Ğ¾Ğ¼Ñ‹ÑˆĞ»ĞµĞ½Ğ½Ğ¸ĞºĞ¾Ğ²

ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ½Ğ¸Ğ¶Ğµ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚ Ğ¸ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ!`;
  
  bot.sendMessage(chatId, welcomeText, {
    parse_mode: 'Markdown',
    reply_markup: {
      inline_keyboard: [[
        {
          text: "ğŸ“± ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ›Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ĞšĞ°Ğ±Ğ¸Ğ½ĞµÑ‚",
          web_app: { url: process.env.APP_URL }
        }
      ]]
    }
  });
});

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
bot.on('message', (msg) => {
  const chatId = msg.chat.id;
  
  // Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ (Ğ¾Ğ½Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾)
  if (msg.text && msg.text.startsWith('/')) {
    return;
  }
  
  // ĞÑ‚Ğ²ĞµÑ‡Ğ°ĞµĞ¼ Ğ½Ğ° Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
  if (msg.text) {
    bot.sendMessage(chatId, `ğŸ’¬ ${msg.text}\n\nĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ /start Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹! ğŸ˜Š`);
  }
});

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº callback queries (ĞµÑĞ»Ğ¸ Ğ±ÑƒĞ´ÑƒÑ‚ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸)
bot.on('callback_query', (callbackQuery) => {
  const msg = callbackQuery.message;
  bot.answerCallbackQuery(callbackQuery.id)
    .then(() => {
      bot.sendMessage(msg.chat.id, 'ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑÑ...');
    });
});

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
bot.on('error', (error) => {
  console.error('âŒ Bot error:', error);
});

bot.on('polling_error', (error) => {
  console.error('âŒ Polling error:', error);
});

// Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²ĞµÑ€Ğ°
app.listen(PORT, () => {
  console.log(`ğŸš€ Server running on port ${PORT}`);
  console.log(`ğŸ“± Mini App: ${process.env.APP_URL}`);
  console.log(`ğŸ‘¥ Users storage: in-memory`);
  console.log(`âœ… Bot is LIVE and waiting for messages!`);
  
  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
  if (!process.env.BOT_TOKEN) {
    console.error('âŒ BOT_TOKEN not found in environment variables!');
  } else {
    console.log(`ğŸ¤– Bot token: ${process.env.BOT_TOKEN.substring(0, 10)}...`);
  }
});
