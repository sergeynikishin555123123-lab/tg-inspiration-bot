import express from 'express';
import db from '../config/database.js';

const router = express.Router();

// –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
router.get('/characters', async (req, res) => {
  try {
    db.all('SELECT * FROM characters ORDER BY class, character_name', (err, characters) => {
      if (err) {
        return res.status(500).json({ error: 'Database error' });
      }
      
      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–ª–∞—Å—Å–∞–º
      const groupedCharacters = characters.reduce((acc, character) => {
        if (!acc[character.class]) {
          acc[character.class] = [];
        }
        acc[character.class].push(character);
        return acc;
      }, {});
      
      res.json(groupedCharacters);
    });
  } catch (error) {
    res.status(500).json({ error: 'Server error' });
  }
});

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤
router.get('/classes', async (req, res) => {
  try {
    const classes = [
      {
        id: '–•—É–¥–æ–∂–Ω–∏–∫–∏',
        name: 'üé® –•—É–¥–æ–∂–Ω–∏–∫–∏',
        description: '–¢–≤–æ—Ä—Ü—ã –∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞—Ç–æ—Ä—ã –≤ –º–∏—Ä–µ –∏–∑–æ–±—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞',
        icon: 'üé®'
      },
      {
        id: '–°—Ç–∏–ª–∏—Å—Ç—ã', 
        name: 'üëó –°—Ç–∏–ª–∏—Å—Ç—ã',
        description: '–ú–∞—Å—Ç–µ—Ä–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤ –∏ —Å—Ç–∏–ª—è',
        icon: 'üëó'
      },
      {
        id: '–ú–∞—Å—Ç–µ—Ä–∞',
        name: 'üßµ –ú–∞—Å—Ç–µ—Ä–∞',
        description: '–†–µ–º–µ—Å–ª–µ–Ω–Ω–∏–∫–∏ –∏ —Ç–≤–æ—Ä—Ü—ã –ø—Ä–∏–∫–ª–∞–¥–Ω–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞',
        icon: 'üßµ'
      },
      {
        id: '–ò—Å—Ç–æ—Ä–∏–∫–∏',
        name: 'üèõÔ∏è –ò—Å—Ç–æ—Ä–∏–∫–∏ –∏—Å–∫—É—Å—Å—Ç–≤–∞',
        description: '–ó–Ω–∞—Ç–æ–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏, —ç–ø–æ—Ö –∏ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π',
        icon: 'üèõÔ∏è'
      }
    ];
    
    res.json(classes);
  } catch (error) {
    res.status(500).json({ error: 'Server error' });
  }
});

// –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–≤–∏–∑–æ–≤
router.get('/quizzes', async (req, res) => {
  try {
    db.all(
      `SELECT * FROM quizzes 
       WHERE is_active = TRUE 
       ORDER BY created_at DESC`,
      (err, quizzes) => {
        if (err) {
          return res.status(500).json({ error: 'Database error' });
        }
        
        // –ü–∞—Ä—Å–∏–º –≤–æ–ø—Ä–æ—Å—ã –∏–∑ JSON
        const parsedQuizzes = quizzes.map(quiz => ({
          ...quiz,
          questions: JSON.parse(quiz.questions)
        }));
        
        res.json(parsedQuizzes);
      }
    );
  } catch (error) {
    res.status(500).json({ error: 'Server error' });
  }
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∫–≤–∏–∑
router.post('/quizzes/:quizId/submit', async (req, res) => {
  try {
    const { quizId } = req.params;
    const { userId, answers } = req.body;
    
    // –ü–æ–ª—É—á–∞–µ–º –∫–≤–∏–∑
    db.get('SELECT * FROM quizzes WHERE id = ?', [quizId], (err, quiz) => {
      if (err) {
        return res.status(500).json({ error: 'Database error' });
      }
      
      if (!quiz) {
        return res.status(404).json({ error: 'Quiz not found' });
      }
      
      const questions = JSON.parse(quiz.questions);
      let correctAnswers = 0;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç—ã
      questions.forEach((question, index) => {
        if (answers[index] === question.correctAnswer) {
          correctAnswers++;
        }
      });
      
      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–∞–≥—Ä–∞–¥—É —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
      let starsEarned = 0;
      if (questions.length <= 3) {
        // –ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø—Ä–æ—Å (3 –≤–æ–ø—Ä–æ—Å–∞)
        starsEarned = correctAnswers >= 1 ? 1 : 0;
      } else {
        // –í–∏–∫—Ç–æ—Ä–∏–Ω–∞ (3-5 –≤–æ–ø—Ä–æ—Å–æ–≤)
        if (correctAnswers >= Math.ceil(questions.length * 0.6)) {
          starsEarned = 2;
        } else if (correctAnswers >= 1) {
          starsEarned = 1;
        }
      }
      
      // TODO: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –±–æ–Ω—É—Å—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
      
      res.json({
        success: true,
        correctAnswers,
        totalQuestions: questions.length,
        starsEarned,
        passed: starsEarned > 0
      });
    });
  } catch (error) {
    res.status(500).json({ error: 'Server error' });
  }
});

export default router;
